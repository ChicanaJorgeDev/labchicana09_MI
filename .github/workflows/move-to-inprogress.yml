name: Move issue to In Progress when PR references it

on:
  pull_request:
    types: [opened, reopened, synchronize, closed]

jobs:
  move_issue_in_progress:
    runs-on: ubuntu-latest

    steps:
      - name: Extract referenced issue number
        id: extract
        run: |
          ISSUE=$(echo "${{ github.event.pull_request.body }}" | grep -oE '#[0-9]+' | head -n1 | tr -d '#')
          echo "issue_number=$ISSUE" >> $GITHUB_ENV

      - name: Move referenced issue to In Progress
        if: env.issue_number != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = process.env.issue_number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const projectName = "Desarrollo App Nutricional (Chicana)"; // cambia si tu proyecto tiene otro título exacto

            // 1️⃣ Buscar el proyecto en el repositorio
            const query = `
              query($owner: String!, $repo: String!) {
                repository(owner: $owner, name: $repo) {
                  projectsV2(first: 10) {
                    nodes {
                      id
                      title
                      fields(first: 20) {
                        nodes {
                          id
                          name
                          ... on ProjectV2SingleSelectField {
                            options { id name }
                          }
                        }
                      }
                    }
                  }
                }
              }
            `;

            const result = await github.graphql(query, { owner, repo });
            const projects = result.repository.projectsV2.nodes;
            const project = projects.find(p => p.title === projectName);

            if (!project) {
              core.warning(`⚠️ No se encontró el proyecto "${projectName}"`);
              return;
            }

            // 2️⃣ Buscar campo Status y opción In Progress
            const statusField = project.fields.nodes.find(f => f.name === "Status");
            if (!statusField) {
              core.warning("⚠️ No se encontró el campo 'Status'");
              return;
            }

            const inProgressOption = statusField.options.find(o => o.name === "In Progress");
            if (!inProgressOption) {
              core.warning("⚠️ No se encontró la opción 'In Progress'");
              return;
            }

            // 3️⃣ Obtener la issue
            const { data: issue } = await github.rest.issues.get({ owner, repo, issue_number: issueNumber });
            const issueNodeId = issue.node_id;

            // 4️⃣ Agregar al proyecto (si aún no está)
            const addMutation = `
              mutation($projectId: ID!, $contentId: ID!) {
                addProjectV2ItemById(input: { projectId: $projectId, contentId: $contentId }) {
                  item { id }
                }
              }
            `;
            const addResult = await github.graphql(addMutation, {
              projectId: project.id,
              contentId: issueNodeId
            });
            const itemId = addResult.addProjectV2ItemById.item.id;

            // 5️⃣ Actualizar Status → In Progress
            const updateMutation = `
              mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                updateProjectV2ItemFieldValue(input: {
                  projectId: $projectId,
                  itemId: $itemId,
                  fieldId: $fieldId,
                  value: { singleSelectOptionId: $optionId }
                }) {
                  projectV2Item { id }
                }
              }
            `;
            await github.graphql(updateMutation, {
              projectId: project.id,
              itemId,
              fieldId: statusField.id,
              optionId: inProgressOption.id
            });

            console.log(`✅ Issue #${issueNumber} movido a In Progress.`);
